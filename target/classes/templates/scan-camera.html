<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Scan QR Code via Kamera</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif']
                    }
                }
            }
        }
    </script>
</head>
<body class="font-inter h-screen w-screen m-0 p-0 bg-cover bg-center bg-fixed flex items-center justify-center"
      style="background-image: url('/images/bg-image.jpg'); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);">

<!-- Fullscreen container -->
<div class="relative w-full h-full px-4 py-6 flex flex-col items-center justify-start">
    <h1 class="text-emerald-700 text-[clamp(1.8rem,2.5vw+1rem,2.5rem)] mb-4 text-center font-extrabold bg-white/70 px-4 py-2 rounded-xl shadow-md backdrop-blur-sm">
        Scan Kehadiran Tamu
    </h1>

    <!-- QR Reader -->
    <div id="reader" class="w-full h-[70vh] rounded-xl overflow-hidden shadow-lg bg-white"></div>

    <!-- Hasil Scan -->
    <div id="result" class="hidden mt-6 text-lg leading-relaxed text-emerald-900 bg-white/80 p-6 rounded-xl border border-emerald-300 shadow-lg backdrop-blur-sm w-[90%] max-w-md"></div>

    <!-- Tombol Kembali -->
    <a href="/scan" class="back-button hidden mt-6 px-6 py-2.5 bg-emerald-400 text-white font-bold rounded-lg transition duration-300 hover:bg-emerald-600">
        ‚¨Ö Kembali
    </a>
</div>

<script>
    function formatDateTime(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Agu", "Sep", "Okt", "Nov", "Des"];
        const month = monthNames[date.getMonth()];
        const year = date.getFullYear();
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${day}-${month}-${year} ${hours}:${minutes}:${seconds}`;
    }

    function onScanSuccess(decodedText) {
        const now = new Date();
        const waktuKedatangan = formatDateTime(now);

        const resultDiv = document.getElementById('result');
        resultDiv.innerHTML = `
            <div><span class="font-semibold text-emerald-700">üì¶ Hasil Scan:</span><br>${decodedText}</div>
            <div class="mt-2"><span class="font-semibold text-emerald-700">‚è∞ Jam Kedatangan:</span><br>${waktuKedatangan}</div>
        `;

        fetch('/api/scan/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hasil: decodedText, waktu: waktuKedatangan })
        }).then(response => {
            if (!response.ok) throw new Error("Gagal menyimpan data ke server");
            return response.json();
        }).then(data => console.log("Data berhasil disimpan:", data))
            .catch(error => console.error("Error saat menyimpan:", error));

        // üîä Putar suara notifikasi
        document.getElementById('success-sound').play();

        window.location.href = `/result?nama=${encodeURIComponent(decodedText)}&waktu=${encodeURIComponent(waktuKedatangan)}`;

        html5QrcodeScanner.clear();
    }

    const html5QrcodeScanner = new Html5QrcodeScanner("reader", {
        fps: 10,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
            return {
                width: Math.floor(minEdge * 0.9),
                height: Math.floor(minEdge * 0.9)
            };
        }
    });

    html5QrcodeScanner.render(onScanSuccess);
</script>

<audio id="success-sound" src="/sounds/success.mp3" preload="auto"></audio>
</body>
</html>
